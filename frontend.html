<!DOCTYPE html>
<html>
<head>
    <title>BloomBERT.in</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
	        background-image: url("static/images/background.jpg");
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
            color: white;
        }
        
        p{
            text-align: center;
            color: white;
            font-size: 10px;
            font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
        }

        .container {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
        }

        .logo {
            width: 200px;
            height: 200px;
        }

        .title {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 30px;
        }
	
        .try-button {
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: #333537;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .try-button:hover {
            background-color: #444648;
        }

        /* Chatbot Styles */
        #chatbot-container {
            display: none;
            max-width: 900px;
            width: 90%;
            height: 600px;
            margin: 0 auto;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
            background-color: rgba(30, 30, 30, 0.7);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        #chat-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: rgba(51, 51, 51, 0.3);
            display: flex;
            flex-direction: column;
            scrollbar-width: thin;
            scrollbar-color: #aaa transparent;
            height: calc(100% - 120px); 
        }

        #chat-area::after {
            content: "";
            display: table;
            clear: both;
        }

        .message {
            border-radius: 15px;
            margin-bottom: 10px; 
            padding: 15px 18px;
            max-width: 75%;
            width: auto;
            position: relative;
            clear: both;
            word-wrap: break-word;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
        }

        .loading {
            font-style: italic;
            opacity: 0.7;
        }

        .error {
            background-color: rgba(244, 67, 54, 0.3) !important;
        }

        .source-link {
            font-size: 0.8em;
            margin-top: 5px;
            display: block;
        }

        .source-link a {
            color: #64B5F6;
            text-decoration: underline;
        }
        
        .user-message {
            background-color: rgba(70, 130, 180, 0.6);
            margin-left: auto;
            text-align: left;
            color: white;
            align-self: flex-end;
        }

        .bot-message {
            background-color: rgba(60, 60, 60, 0.7);
            margin-right: auto;
            text-align: left;
            color: white;
            align-self: flex-start;
        }

        .profit {
            color: #4CAF50;
            font-weight: bold;
            margin-left: 5px;
        }

        .loss {
            color: #F44336;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Input Area Styles */
        #input-area {
            display: flex;
            padding: 10px;
            background-color: rgba(38, 50, 56, 0.7);
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        #user-input {
            flex-grow: 1;
            padding: 12px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(38, 50, 56, 0.7);
            color: white;
            margin-right: 10px;
        }

        #send-button {
            padding: 10px 20px;
            background-color: #333537;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #send-button:hover {
            background-color: #444648;
        }

        /* Feedback button styling - Updated */
        .feedback-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .feedback-buttons button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .feedback-buttons button:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Back Button Styles */
        #back-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            display: none;
        }

        .flash-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* Ensures 4 columns */
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            justify-items: center;
        }

        .flash-card {
            width: 100%;
            max-width: 250px;
            height: 250px;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            background: transparent;
        }

        .flash-card:hover {
            transform: scale(1.1);
            background: black;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }

        .flash-card img {
            width: 100%;
            height: 70%;
            object-fit: cover;
            border-radius: 12px;
            transition: opacity 0.3s ease-in-out;
        }

        .flash-card:hover img {
            opacity: 0.3;
        }

        .flash-card .caption {
            text-align: center;
            font-weight: bold;
            color: white;
            transition: color 0.3s ease-in-out;
        }

        .flash-card:hover .caption {
            color: white;
        }

        .hamburger {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 30px;
            cursor: pointer;
            z-index: 1000;
        }
        .sidebar {
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            padding-top: 60px;
            transition: 0.3s;
            z-index: 999;
        }
        .sidebar a {
            display: block;
            overlay: hidden;
            font-size: 18px;
            margin: 15px;
            text-decoration: none;
            color: white;
            padding: 10px;
        }
        .sidebar a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #prediction-section {
            display: none; /* Initially hidden */
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-move {
            display: flex;
            gap: 5px;
            align-items: flex-end;
            height: 50px;
        }

        .loading-bar {
            width: 6px;
            height: 30px;
            background-color: slategray;
            animation: bar-move 1s ease-in-out infinite;
        }

        .loading-bar:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-bar:nth-child(3) {
            animation-delay: 0.4s;
        }
        .loading-bar:nth-child(4) {
            animation-delay: 0.6s;
        }
        .loading-bar:nth-child(5) {
            animation-delay: 0.8s;
        }

        @keyframes bar-move {
            0%, 100% { height: 20px; background-color: snow; }
            50% { height: 50px; background-color: slategrey; }
        }

        @media screen and (max-width: 600px) {
            #chatbot-container {
                width: 95%;
                height: 400px;
            }
        }
        
        /* Chat Header */
        .chat-header {
            background-color: #333;
            padding: 15px 20px;
            border-bottom: 1px solid #444;
        }
        
        .chat-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        
        #chatbot-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
            color: white;
        }

        .quote-container {
            max-width: 800px;
            margin: 20px;
            font-size: 1.5em;
            font-style: italic;
            text-align: center;
        }

        .quote-author {
            font-size: 1em;
            margin-top: 10px;
            text-align: right;
            opacity: 0.8;
        }

        .continue-button {
            margin-top: 40px;
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: #333537;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .continue-button:hover {
            background-color: #444648;
        }
    </style>
</head>

<div class="hamburger" onclick="toggleSidebar()">&#9776;</div>
<div class="sidebar" id="sidebar">
    <a href="http://localhost:8502/">Stock at a glance</a>
    <a href="http://localhost:8504">News</a>
    <a href="http://localhost:8503/">Stock Symbol</a>
    <a href="http://127.0.0.1:5000/">Currency Rates</a>
</div>

<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-move">
        <div class="loading-bar"></div>
        <div class="loading-bar"></div>
        <div class="loading-bar"></div>
        <div class="loading-bar"></div>
        <div class="loading-bar"></div>
    </div>
    <h3 style="color: aliceblue; font-family: 'Courier New', Courier, monospace; font-size: xx-large">Welcome to BloomBERT</h3>
    <p style="color: aliceblue; font-family: 'Courier New', Courier, monospace; font-size: larger">Your one place for hassle free and reliable financial information!</p>
    <p style="color: aliceblue; font-family: 'Courier New', Courier, monospace; font-size: medium;">Please wait while we load the required models...</p>
</div>

<div class="container">
    <img src="{{url_for('static',filename='images/BloomBERT logo.png')}}" alt="Logo" class="logo">
    <h1 class="title" style="font-size: 50px; font-family: Modern Grotesque Sans-Serif">BloomBERT</h1>
    <h3 style="font-family:Merriweather"> Get all Financial Information from trusted sources just in one-click!<br> Hassle free and reliable financial information & news on BloomBERT. </h3>

    <button class="try-button" id="chat-button" onclick="displayRandomQuote()">Try Now</button>
    <button class="try-button" id="predict-button">Predict your Stocks</button>
    <script>
    document.getElementById("predict-button").addEventListener("click", function () {
        window.location.href = "http://localhost:8501/";
    });
    </script>
</div>

<div id="chatbot-loading">
    <div class="quote-container">
        <h1 id="trading-quote"></h1>
        <h5 id="quote-author"><u></u></h5>
        <footer style="color: aliceblue; font-family: 'Courier New', Courier, monospace; font-size: medium;">Please wait while the bot is loading ...</footer>
    </div>
</div>

<!-- IMPORTANT: Fixed chatbot container structure -->
<div id="chatbot-container">
    <div class="chat-header">
        <h2 class="chat-title">BloomBERT Financial Assistant</h2>
    </div>
    <div id="chat-area">
        <!-- Chat messages will be inserted here by JavaScript -->
    </div>
    <div id="input-area">
        <input type="text" id="user-input" placeholder="Ask about a stock or company...">
        <button id="send-button">Send</button>
    </div>
</div>

<button id="back-button">Back</button>

<div class="flash-cards">
    <div class="flash-card" onclick="window.location.href='https://groww.in/p/what-is-sensex'">
        <img src="{{url_for('static',filename='images/sensex.webp')}}" alt="Image 1">
        <div class="caption">Sensex</div>
        <p><i>Benchmark index of BSE tracking 30 top Indian company stocks</i></p>
    </div>
    <div class="flash-card" onclick="window.location.href='https://groww.in/indices/nifty'">
        <img src="{{url_for('static',filename='images/nifty_50.webp')}}" alt="Image 2">
        <div class="caption">NIFTY 50</div>
        <p><i>Index of India's top 50 NSE-listed large-cap stocks</i></p>
    </div>
    <div class="flash-card" onclick="window.location.href='https://groww.in/ipo'">
        <img src="{{url_for('static',filename='images/ipo.webp')}}" alt="Image 3">
        <div class="caption">IPO-Initial Public Offering</div>
        <p><i>Initial public share sale for raising capital in markets</i></p>
    </div>        
    <div class="flash-card" onclick="window.location.href='https://www.angelone.in/finance-wiki/mutual-funds'">
        <img src="{{url_for('static',filename='images/Mutual Funds.webp')}}" alt="Image 4">
        <div class="caption">Mutual Funds</div>
        <p><i>Professionally managed pooled investments in stocks, bonds, or assets</i></p>
    </div>
    <div class="flash-card" onclick="window.location.href='https://groww.in/p/sip-systematic-investment-plan'">
        <img src="{{url_for('static',filename='images/SIP.webp')}}" alt="Image 5">
        <div class="caption">SIP-Systematic Investment Plan</div>
        <p><i>Disciplined investment method in mutual funds through regular contributions</i></p>
    </div>
    <div class="flash-card" onclick="window.location.href='https://www.angelone.in/finance-wiki/commodity'">
        <img src="{{url_for('static',filename='images/Commodities.webp')}}" alt="Image 6">
        <div class="caption">Commodities Investment</div>
        <p><i>Tradeable physical goods like gold, oil, and agricultural products</i></p>
    </div>        
    <div class="flash-card" onclick="window.location.href='https://www.investopedia.com/terms/e/equity_derivative.asp'">
        <img src="{{url_for('static',filename='images/equity.webp')}}" alt="Image 7">
        <div class="caption">Equity</div>
        <p><i>Total amount of money that a shareholder is eligible to receive if all of a company's debts are paid off</i></p>
    </div>
    <div class="flash-card" onclick="window.location.href='https://groww.in/p/what-is-derivatives'">
        <img src="{{url_for('static',filename='images/derivatives.webp')}}" alt="Image 8">
        <div class="caption">Derivatives</div>
        <p><i>A financial instrument whose value is derived from an underlying asset, commodity or index</i></p>
    </div>
    <div class="flash-card" onclick="window.location.href='https://groww.in/p/intraday-trading'">
        <img src="{{url_for('static',filename='images/Intraday.webp')}}" alt="Image 9">
        <div class="caption">Intra-day Trading</div>
        <p><i>Purchasing and selling securities listed in a stock exchange on the same day</i></p>
    </div>
    <div class="flash-card" onclick="window.location.href='https://www.angelone.in/knowledge-center/share-market/bull-vs-bear-market'">
        <img src="{{url_for('static',filename='images/bbmarket.webp')}}" alt="Image 10">
        <div class="caption">Bullish v/s Bearish Maket</div>
        <p><i>The bull market is when the stock prices are rising, whereas the bear market when it is falling</i></p>
    </div>
    <div class="flash-card" onclick="window.location.href='https://www.tickertape.in/blog/best-multibagger-stocks/'">
        <img src="{{url_for('static',filename='images/multibagger.webp')}}" alt="Image 11">
        <div class="caption">Multibaggers</div>
        <p><i>Provide returns several times their initial investment over a specific period</i></p>
    </div>
    <div class="flash-card" onclick="window.location.href='https://aliceblueonline.com/what-is-brokerage-in-stock-market/'">
        <img src="{{url_for('static',filename='images/brokerage.webp')}}" alt="Image 12">
        <div class="caption">Brokerage</div>  
        <p><i>A fee paid to a broker for buying or selling shares</i></p>   
    </div>
</div>

<script>
    // Get DOM elements
   // Get DOM elements
const chatbotContainer = document.getElementById('chatbot-container');
const chatArea = document.getElementById('chat-area');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');
const backButton = document.getElementById('back-button');
const landingContainer = document.querySelector('.container');
const flashcards = document.querySelector('.flash-cards');
const loadingOverlay = document.getElementById('loadingOverlay');
const chatbotLoading = document.getElementById('chatbot-loading');
const predictButton = document.getElementById('predict-button');

// Set initial UI state
document.addEventListener("DOMContentLoaded", function() {
    // Initially hide main container and show loading overlay
    if (loadingOverlay) loadingOverlay.style.display = "flex";
    if (landingContainer) landingContainer.style.display = "none";
    if (chatbotLoading) chatbotLoading.style.display = "none";
    if (chatbotContainer) chatbotContainer.style.display = "none";
    if (backButton) backButton.style.display = "none";
    
    // Start checking model status
    checkModelStatus();
    
    // Set up event listeners once the DOM is fully loaded
    if (backButton) {
        backButton.addEventListener('click', function() {
            // Hide chatbot or prediction
            if (chatbotContainer) chatbotContainer.style.display = "none";
            const predictionSection = document.getElementById('prediction-section');
            if (predictionSection) predictionSection.style.display = "none";
            if (backButton) backButton.style.display = "none";
            
            // Show main container and flashcards
            if (landingContainer) landingContainer.style.display = "block";
            if (flashcards) flashcards.style.display = "grid";
        });
    }

    if (sendButton && userInput) {
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    }
    
    // Add listener for predict button
    if (predictButton) {
        predictButton.addEventListener('click', startPredict);
    }
    
    // Set up responsive flashcards
    const flashCards = document.querySelector('.flash-cards');
    if (flashCards) {
        // Update the grid layout for better mobile responsiveness
        const updateLayout = () => {
            if (window.innerWidth < 768) {
                flashCards.style.gridTemplateColumns = 'repeat(2, 1fr)';
            } else if (window.innerWidth < 1024) {
                flashCards.style.gridTemplateColumns = 'repeat(3, 1fr)';
            } else {
                flashCards.style.gridTemplateColumns = 'repeat(4, 1fr)';
            }
        };
        
        // Set initial layout
        updateLayout();
        
        // Update on resize
        window.addEventListener('resize', updateLayout);
    }
});

// Function to check model status with polling
async function checkModelStatus() {
    try {
        console.log("Checking model status...");
        const response = await fetch("/status");
        
        // Check if the response is OK before trying to parse JSON
        if (!response.ok) {
            throw new Error(`Server responded with status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("[DEBUG] Status check:", data);

        if (data && data.status === "ready") {
            console.log("Models ready! Showing main container");
            
            // Hide the loading overlay with a fade-out effect
            if (loadingOverlay) {
                loadingOverlay.style.opacity = "0";
                loadingOverlay.style.transition = "opacity 0.5s ease";
                setTimeout(() => {
                    loadingOverlay.style.display = "none";
                }, 500);
            }
            
            // Show the main container and flashcards
            if (landingContainer) landingContainer.style.display = "block";
            if (flashcards) flashcards.style.display = "grid";
            
        } else {
            // If server responds but models aren't ready yet
            console.log("Models still loading, checking again in 2 seconds");
            setTimeout(checkModelStatus, 2000);
        }
    } catch (err) {
        console.error("Error fetching status:", err);
        
        // Initialize retries counter if it doesn't exist
        if (window.modelCheckRetries === undefined) {
            window.modelCheckRetries = 1;
        } else {
            window.modelCheckRetries++;
        }
        
        // After 5 retries, show the UI anyway
        if (window.modelCheckRetries > 5) {
            console.log("Showing UI after multiple failed status checks");
            
            // Add a warning message to the user
            const warningDiv = document.createElement('div');
            warningDiv.style.position = "fixed";
            warningDiv.style.top = "10px";
            warningDiv.style.left = "50%";
            warningDiv.style.transform = "translateX(-50%)";
            warningDiv.style.backgroundColor = "rgba(255, 200, 0, 0.9)";
            warningDiv.style.color = "black";
            warningDiv.style.padding = "10px 20px";
            warningDiv.style.borderRadius = "5px";
            warningDiv.style.zIndex = "2000";
            warningDiv.style.boxShadow = "0 2px 10px rgba(0,0,0,0.2)";
            warningDiv.textContent = "Warning: Some services might not be fully loaded. You may experience limited functionality.";
            document.body.appendChild(warningDiv);
            
            // Hide warning after 8 seconds
            setTimeout(() => {
                warningDiv.style.opacity = "0";
                warningDiv.style.transition = "opacity 1s ease";
                setTimeout(() => document.body.removeChild(warningDiv), 1000);
            }, 8000);
            
            // Show main UI
            if (loadingOverlay) loadingOverlay.style.display = "none";
            if (landingContainer) landingContainer.style.display = "block";
            if (flashcards) flashcards.style.display = "grid";
        } else {
            // Exponential backoff for retries (1s, 2s, 4s, 8s, 16s)
            const retryDelay = Math.min(1000 * Math.pow(2, window.modelCheckRetries - 1), 16000);
            console.log(`Retrying in ${retryDelay/1000} seconds (attempt ${window.modelCheckRetries})`);
            setTimeout(checkModelStatus, retryDelay);
        }
    }
}

// Function to get time-based trading quote
function getTimedQuote() {
    const hour = new Date().getHours();
    
    if (hour >= 5 && hour < 8) {
        return "Early bird trader! Getting ready for market open?";
    } 
    else if (hour >= 8 && hour < 9) {
        return "Preparing for market open? Let me help you analyze today's opportunities.";
    } 
    else if (hour >= 9 && hour < 16) {
        return "Markets are open! What stocks are you watching today?";
    } 
    else if (hour >= 16 && hour < 18) {
        return "Reviewing today's market moves? Let's analyze your portfolio performance.";
    } 
    else if (hour >= 18 && hour < 22) {
        return "Planning tomorrow's trades? Smart traders prepare ahead.";
    } 
    else {
        return "Burning the midnight oil? Dedicated traders like you make the difference.";
    }
}

// Function to display quote and transition to chatbot
function displayRandomQuote() {
    console.log("Displaying random quote and preparing chatbot");
    
    // Hide elements
    if (landingContainer) landingContainer.style.display = "none";
    if (flashcards) flashcards.style.display = "none";
    
    // Show loading screen
    if (chatbotLoading) chatbotLoading.style.display = "flex";
    
    // Display the time-based quote
    const quoteElement = document.getElementById('trading-quote');
    const authorElement = document.getElementById('quote-author');
    
    if (quoteElement) quoteElement.textContent = `"${getTimedQuote()}"`;
    if (authorElement) authorElement.textContent = "";
    
    // Show back button
    if (backButton) backButton.style.display = "block";
    
    // Auto-transition to chatbot after delay
    setTimeout(function() {
        startChatbot();
    }, 3000); // 3 seconds delay
}

// Function to start the chatbot interface
function startChatbot() {
    console.log("Starting chatbot interface");
    
    try {
        // Hide the quote loading screen
        if (chatbotLoading) chatbotLoading.style.display = "none";
        
        // Show the chatbot container
        if (chatbotContainer) {
            chatbotContainer.style.display = "flex";
            
            // Check if chat area exists before adding messages
            if (chatArea) {
                // Clear any existing messages (in case this isn't first load)
                chatArea.innerHTML = '';
                
                // Add initial bot message
                addMessage("Welcome to BloomBERT! How can I help you with stock information today?", "bot");
                
                // Focus the input field for immediate typing
                if (userInput) {
                    userInput.focus();
                }
            } else {
                console.error("Chat area not found within chatbot container");
                throw new Error("Chat area not found");
            }
        } else {
            console.error("Chatbot container not found!");
            throw new Error("Chatbot container not found");
        }
    } catch (error) {
        console.error("Error starting chatbot:", error);
        // Fallback - return to main page
        if (landingContainer) landingContainer.style.display = "block";
        if (flashcards) flashcards.style.display = "grid";
        
        // Show error toast
        showToast("Error starting chatbot. Please try again later.", "error");
    }
}

// Function to start the prediction interface
function startPredict() {
    console.log("Starting prediction interface");
    
    // Hide the main container and flashcards
    if (landingContainer) landingContainer.style.display = "none";
    if (flashcards) flashcards.style.display = "none";
    
    // Show back button
    if (backButton) backButton.style.display = "block";
    
    // Show the streamlit frame
    const streamlitFrame = document.getElementById('streamlit-frame');
    if (streamlitFrame) {
        streamlitFrame.src = "http://localhost:8501";
        streamlitFrame.style.display = "block";
        
        // Show the prediction section
        const predictionSection = document.getElementById('prediction-section');
        if (predictionSection) {
            predictionSection.style.display = "block";
        }
    } else {
        console.error("Streamlit frame not found!");
        // Fallback - return to main page
        if (landingContainer) landingContainer.style.display = "block";
        if (flashcards) flashcards.style.display = "grid";
        
        // Show error toast
        showToast("Prediction frame could not be loaded.", "error");
    }
}

// Unified message addition function
function addMessage(text, sender, options = {}) {
    if (!chatArea) return;
    
    // Create the message container
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    if (options.isLoading) messageDiv.classList.add('loading');
    if (options.isError) messageDiv.classList.add('error');
    
    // Create the message content
    messageDiv.textContent = text;
    
    // Add profit/loss indicator if available
    if (options.profitLoss) {
        const profitLossSpan = document.createElement('span');
        profitLossSpan.className = options.profitLoss === "profit" ? 'profit' : 'loss';
        profitLossSpan.textContent = ` (${options.profitLoss.toUpperCase()})`;
        messageDiv.appendChild(profitLossSpan);
    }
    
    // Add feedback buttons for bot messages only
    if (sender === "bot" && !options.isLoading) {
        const feedbackDiv = document.createElement('div');
        feedbackDiv.className = 'feedback-buttons';
        
        const thumbsUpButton = document.createElement('button');
        thumbsUpButton.innerHTML = '👍';
        thumbsUpButton.addEventListener('click', () => sendFeedback(1, messageDiv));
        
        const thumbsDownButton = document.createElement('button');
        thumbsDownButton.innerHTML = '👎';
        thumbsDownButton.addEventListener('click', () => sendFeedback(-1, messageDiv));
        
        feedbackDiv.appendChild(thumbsUpButton);
        feedbackDiv.appendChild(thumbsDownButton);
        messageDiv.appendChild(feedbackDiv);
    }
    
    // Add source link if provided
    if (options.source) {
        const sourceDiv = document.createElement('div');
        sourceDiv.className = 'source-link';
        const sourceLink = document.createElement('a');
        sourceLink.href = options.source;
        sourceLink.target = '_blank';
        sourceLink.textContent = 'Source';
        sourceDiv.appendChild(sourceLink);
        messageDiv.appendChild(sourceDiv);
    }
    
    // Add to chat area
    chatArea.appendChild(messageDiv);
    
    // Scroll to bottom
    chatArea.scrollTop = chatArea.scrollHeight;
    
    return messageDiv; // Return for potential later reference
}

// Function to send feedback
function sendFeedback(rating, messageElement) {
    console.log("Feedback received:", rating);
    // Here you would typically send the feedback to your server
    
    // Visual feedback to user
    const thumbsButtons = messageElement.querySelectorAll('.feedback-buttons button');
    thumbsButtons.forEach(button => {
        button.style.opacity = "0.5";
        button.disabled = true;
    });
    
    // Show feedback toast
    showToast(rating > 0 ? "Thanks for your positive feedback!" : "Thanks for your feedback. We'll work to improve.", 
              rating > 0 ? "success" : "info");
    
    // You could send this feedback to the server
    /* 
    fetch('/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rating: rating, message: messageElement.textContent })
    });
    */
}

// Send message function
async function sendMessage() {
    if (!userInput || !chatArea) return;
    
    const message = userInput.value.trim();
    if (!message) return;
    
    // Clear input and disable to prevent double-sends
    userInput.value = '';
    userInput.disabled = true;
    sendButton.disabled = true;
    
    try {
        // Add user message to chat
        addMessage(message, "user");
        
        // Add loading indicator
        const loadingDiv = addMessage("Thinking...", "bot", {isLoading: true});
        
        // Send message to server
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        const response = await fetch('/get_response', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Remove loading indicator
        if (loadingDiv && loadingDiv.parentNode) {
            chatArea.removeChild(loadingDiv);
        }
        
        // Add bot response with any additional info
        addMessage(data.message, "bot", {
            source: data.source || null,
            profitLoss: data.prediction_type || null
        });
        
    } catch (error) {
        console.error('Error:', error);
        
        // Find and remove loading indicator if it exists
        const loadingDivs = chatArea.querySelectorAll('.loading');
        loadingDivs.forEach(div => {
            if (div.parentNode) {
                chatArea.removeChild(div);
            }
        });
        
        // Add appropriate error message based on the error
        let errorMessage = "Sorry, there was an error processing your request.";
        if (error.name === "AbortError") {
            errorMessage = "Request timed out. Please try again.";
        } else if (error.message.includes("NetworkError")) {
            errorMessage = "Network error. Please check your connection.";
        }
        
        addMessage(errorMessage, "bot", {isError: true});
    } finally {
        // Re-enable input controls
        userInput.disabled = false;
        sendButton.disabled = false;
        userInput.focus();
    }
}

// Function to toggle sidebar with improved behavior
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    if (!sidebar) return;
    
    const isOpen = sidebar.style.left === "0px";
    
    // Add transition for smoother animation
    sidebar.style.transition = "left 0.3s ease";
    sidebar.style.left = isOpen ? "-250px" : "0px";
    
    // Add overlay when sidebar is open
    let overlay = document.getElementById('sidebar-overlay');
    if (!overlay && !isOpen) {
        overlay = document.createElement('div');
        overlay.id = 'sidebar-overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
        overlay.style.zIndex = '998';
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.3s ease';
        document.body.appendChild(overlay);
        
        // Fade in
        setTimeout(() => {
            overlay.style.opacity = '1';
        }, 10);
        
        overlay.addEventListener('click', toggleSidebar);
    } else if (overlay && isOpen) {
        // Fade out and remove
        overlay.style.opacity = '0';
        setTimeout(() => {
            if (overlay.parentNode) {
                document.body.removeChild(overlay);
            }
        }, 300);
    }
}

// Close sidebar when clicking outside
document.addEventListener("click", function(event) {
    const sidebar = document.getElementById("sidebar");
    const hamburger = document.querySelector(".hamburger");
    
    // Skip if it's the overlay (handled by the overlay's own click handler)
    if (event.target.id === 'sidebar-overlay') return;
    
    if (sidebar && hamburger && 
        !sidebar.contains(event.target) && 
        !hamburger.contains(event.target) && 
        sidebar.style.left === "0px") {
        toggleSidebar();
    }
});

// Toast notification system for user feedback
function showToast(message, type = "info") {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.position = 'fixed';
        toastContainer.style.bottom = '20px';
        toastContainer.style.right = '20px';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.style.minWidth = '250px';
    toast.style.margin = '10px';
    toast.style.padding = '15px';
    toast.style.borderRadius = '5px';
    toast.style.boxShadow = '0 0 10px rgba(0,0,0,0.2)';
    toast.style.display = 'flex';
    toast.style.justifyContent = 'space-between';
    toast.style.alignItems = 'center';
    toast.style.transition = 'all 0.5s ease';
    toast.style.opacity = '0';
    toast.style.color = 'white';
    
    // Set style based on type
    if (type === "error") {
        toast.style.backgroundColor = 'rgba(244, 67, 54, 0.9)';
    } else if (type === "success") {
        toast.style.backgroundColor = 'rgba(76, 175, 80, 0.9)';
    } else {
        toast.style.backgroundColor = 'rgba(33, 150, 243, 0.9)';
    }
    
    // Add message
    toast.textContent = message;
    
    // Add close button
    const closeBtn = document.createElement('span');
    closeBtn.textContent = '×';
    closeBtn.style.marginLeft = '15px';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.fontSize = '20px';
    closeBtn.onclick = function() {
        toast.style.opacity = '0';
        setTimeout(() => {
            if (toast.parentNode) {
                toastContainer.removeChild(toast);
            }
        }, 500);
    };
    toast.appendChild(closeBtn);
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Fade in
    setTimeout(() => {
        toast.style.opacity = '1';
    }, 10);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
            if (toast.parentNode) {
                toastContainer.removeChild(toast);
            }
        }, 500);
    }, 5000);
}

</script>
</body>
</html>